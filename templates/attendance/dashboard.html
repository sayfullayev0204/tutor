{% extends 'base.html' %}
{% load static %}

{% block title %}Davomad - Boshqaruv paneli{% endblock %}

{% block extra_css %}
<style>
    .attendance-card {
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    
    .attendance-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 16px rgba(0,0,0,0.15);
    }
    
    .period-badge {
        font-size: 0.85rem;
        padding: 0.4rem 0.8rem;
        border-radius: 20px;
        font-weight: 500;
    }
    
    .status-completed {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }
    
    .status-pending {
        background-color: #fff3cd;
        color: #856404;
        border: 1px solid #ffeaa7;
    }
    
    .status-missed {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }
    
    .take-attendance-btn {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        border-radius: 8px;
        color: white;
        padding: 0.5rem 1rem;
        font-weight: 500;
        transition: all 0.3s ease;
    }
    
    .take-attendance-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        color: white;
    }
    
    .current-period-indicator {
        background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 25px;
        font-weight: 600;
        display: inline-block;
        margin-bottom: 1rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 class="mb-0">
                    <i class="fas fa-clipboard-check text-primary me-2"></i>
                    Davomad boshqaruvi
                </h2>
                
                {% if current_period %}
                    <div class="current-period-indicator">
                        <i class="fas fa-clock me-2"></i>
                        Hozirgi para: {{ current_period }}
                    </div>
                {% else %}
                    <div class="badge bg-secondary fs-6 py-2 px-3">
                        <i class="fas fa-pause me-2"></i>
                        Dars vaqti emas
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

    {% if user_role == 'tutor' %}
        <!-- Tutor ko'rinishi -->
        <div class="row">
            {% for group_data in groups_data %}
                <div class="col-lg-6 col-xl-4 mb-4">
                    <div class="card attendance-card h-100">
                        <div class="card-header bg-primary text-white">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-users me-2"></i>
                                {{ group_data.group.name }}
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <small class="text-muted">Fakultet:</small>
                                <div class="fw-bold">{{ group_data.group.faculty.name }}</div>
                            </div>
                            
                            <div class="periods-status">
                                <h6 class="mb-3">Bugungi davomad:</h6>
                                {% for period_data in group_data.periods %}
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <span class="fw-medium">{{ period_data.period }}</span>
                                        
                                        {% if period_data.status == 'completed' %}
                                            <span class="period-badge status-completed">
                                                <i class="fas fa-check me-1"></i>Tugallangan
                                            </span>
                                        {% elif period_data.status == 'pending' %}
                                            {% if period_data.can_take %}
                                                <a href="{% url 'take_attendance' period_data.attendance_id %}" 
                                                   class="btn take-attendance-btn btn-sm">
                                                    <i class="fas fa-clipboard-check me-1"></i>Davomad olish
                                                </a>
                                            {% else %}
                                                <span class="period-badge status-pending">
                                                    <i class="fas fa-clock me-1"></i>Kutilmoqda
                                                </span>
                                            {% endif %}
                                        {% elif period_data.status == 'missed' %}
                                            <span class="period-badge status-missed">
                                                <i class="fas fa-times me-1"></i>O'tkazib yuborilgan
                                            </span>
                                        {% else %}
                                            <span class="period-badge bg-light text-muted">
                                                <i class="fas fa-minus me-1"></i>Yaratilmagan
                                            </span>
                                        {% endif %}
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
            {% empty %}
                <div class="col-12">
                    <div class="alert alert-info text-center">
                        <i class="fas fa-info-circle me-2"></i>
                        Sizga biriktirilgan guruhlar topilmadi.
                    </div>
                </div>
            {% endfor %}
        </div>
        
    {% elif user_role == 'dean' %}
        <!-- Dekan ko'rinishi -->
        <div class="row">
            <div class="col-12 mb-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-university me-2"></i>
                            {{ faculty.name }} - Guruhlar davomadi
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th>Guruh nomi</th>
                                        <th>Tutor</th>
                                        <th>Tugallangan paralar</th>
                                        <th>Status</th>
                                        <th>Amallar</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for group_data in groups_data %}
                                        <tr>
                                            <td class="fw-bold">{{ group_data.group.name }}</td>
                                            <td>
                                                {% if group_data.group.tutor %}
                                                    {{ group_data.group.tutor.get_full_name }}
                                                {% else %}
                                                    <span class="text-muted">Tutor biriktirilmagan</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                <div class="progress" style="height: 20px;">
                                                    {% widthratio group_data.completed_periods group_data.total_periods 100 as progress_width %}
                                                    <div class="progress-bar" role="progressbar" 
                                                         style="width: {{ progress_width }}%">
                                                        {{ group_data.completed_periods }}/{{ group_data.total_periods }}
                                                    </div>
                                                </div>
                                            </td>
                                            <td>
                                                {% if group_data.status == 'completed' %}
                                                    <span class="badge bg-success">Tugallangan</span>
                                                {% else %}
                                                    <span class="badge bg-warning">Kutilmoqda</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                <a href="{% url 'history' %}?group={{ group_data.group.id }}" 
                                                   class="btn btn-sm btn-outline-primary">
                                                    <i class="fas fa-history me-1"></i>Tarix
                                                </a>
                                            </td>
                                        </tr>
                                    {% empty %}
                                        <tr>
                                            <td colspan="5" class="text-center text-muted py-4">
                                                Guruhlar topilmadi
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
    {% elif user_role == 'rector' %}
        <!-- Rektor ko'rinishi -->
        <div class="row">
            {% for faculty_data in faculties_data %}
                <div class="col-lg-6 col-xl-4 mb-4">
                    <div class="card attendance-card h-100">
                        <div class="card-header bg-success text-white">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-university me-2"></i>
                                {{ faculty_data.faculty.name }}
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row text-center mb-3">
                                <div class="col-6">
                                    <div class="h4 mb-0 text-primary">{{ faculty_data.total_groups }}</div>
                                    <small class="text-muted">Jami guruhlar</small>
                                </div>
                                <div class="col-6">
                                    <div class="h4 mb-0 text-success">{{ faculty_data.completed_groups }}</div>
                                    <small class="text-muted">Tugallangan</small>
                                </div>
                            </div>
                            
                            <div class="progress mb-3" style="height: 8px;">
                                {% if faculty_data.total_groups > 0 %}
                                    {% widthratio faculty_data.completed_groups faculty_data.total_groups 100 as progress_width %}
                                    <div class="progress-bar bg-success" role="progressbar" 
                                         style="width: {{ progress_width }}%"></div>
                                {% endif %}
                            </div>
                            
                            <div class="text-center">
                                {% if faculty_data.status == 'completed' %}
                                    <span class="badge bg-success fs-6 py-2 px-3">
                                        <i class="fas fa-check me-1"></i>Barcha guruhlar tugallangan
                                    </span>
                                {% else %}
                                    <span class="badge bg-warning fs-6 py-2 px-3">
                                        <i class="fas fa-clock me-1"></i>Kutilmoqda
                                    </span>
                                {% endif %}
                            </div>
                            
                            <div class="mt-3">
                                <a href="{% url 'faculty_groups' faculty_data.faculty.id %}" 
                                   class="btn btn-outline-primary w-100">
                                    <i class="fas fa-eye me-2"></i>Batafsil ko'rish
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            {% empty %}
                <div class="col-12">
                    <div class="alert alert-info text-center">
                        <i class="fas fa-info-circle me-2"></i>
                        Fakultetlar topilmadi.
                    </div>
                </div>
            {% endfor %}
        </div>
    {% endif %}

    <!-- Umumiy havolalar -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-md-4 mb-3 mb-md-0">
                            <a href="{% url 'history' %}" class="btn btn-outline-info w-100">
                                <i class="fas fa-history me-2"></i>
                                Davomad tarixi
                            </a>
                        </div>
                        <div class="col-md-4 mb-3 mb-md-0">
                            <button class="btn btn-outline-warning w-100" onclick="markMissedAttendances()">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                O'tkazib yuborilganlarni belgilash
                            </button>
                        </div>
                        <div class="col-md-4">
                            <a href="#" class="btn btn-outline-secondary w-100">
                                <i class="fas fa-chart-bar me-2"></i>
                                Hisobotlar
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function markMissedAttendances() {
    if (confirm('O\'tkazib yuborilgan davomadlarni belgilashni xohlaysizmi?')) {
        fetch('{% url "mark_missed" %}', {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'Content-Type': 'application/json',
            },
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(`${data.missed_count} ta davomad o'tkazib yuborilgan deb belgilandi.`);
                location.reload();
            } else {
                alert('Xatolik yuz berdi: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Xatolik yuz berdi!');
        });
    }
}

// Auto refresh every 5 minutes
setInterval(function() {
    location.reload();
}, 300000);
</script>
{% endblock %}
