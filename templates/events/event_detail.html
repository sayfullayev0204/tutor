{% extends 'base.html' %}
{% load static %}

{% block title %}{{ event.title }} - Tadbir tafsilotlari{% endblock %}

{% block extra_css %}
<style>
/* Your existing CSS, trimmed for brevity */
.event-card {
  transition: all 0.3s ease;
  border: 1px solid #e3e6f0;
  border-radius: 8px;
}
.event-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
  border-color: #28a745;
}
.event-description {
  background-color: #f8f9fc;
  padding: 0.75rem;
  border-radius: 6px;
  border: 1px solid #e3e6f0;
  border-left: 4px solid #007bff;
}
.dean-comment {
  background-color: #fff3cd;
  padding: 0.75rem;
  border-radius: 6px;
  border-left: 4px solid #ffc107;
}
.photos-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
  gap: 10px;
  padding: 15px;
}
.photo-item {
  position: relative;
  border-radius: 8px;
  overflow: hidden;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  transition: transform 0.3s ease;
}
.photo-item:hover {
  transform: scale(1.05);
}
.photo-thumbnail {
  width: 100%;
  height: 120px;
  object-fit: cover;
  cursor: pointer;
  transition: opacity 0.3s ease;
}
.photo-thumbnail:hover {
  opacity: 0.9;
}
.photo-caption {
  position: absolute;
  bottom: 0;
  left: 0;
  right: 0;
  background: linear-gradient(transparent, rgba(0, 0, 0, 0.7));
  color: white;
  padding: 10px 8px 5px;
  font-size: 0.75rem;
}
.badge-lg {
  padding: 0.5rem 0.75rem;
  font-size: 0.875rem;
}
.avatar-circle {
  width: 35px;
  height: 35px;
  border-radius: 50%;
  background-color: #4e73df;
  color: white;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  font-size: 0.8rem;
}
@media (max-width: 768px) {
  .photos-grid {
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
  }
  .photo-thumbnail {
    height: 100px;
  }
}
.event-card {
  animation: fadeInUp 0.6s ease-out;
}
@keyframes fadeInUp {
  from {
    opacity: 0;
    transform: translateY(30px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}
.modal .close {
  padding: 1rem;
  margin: -1rem -1rem -1rem auto;
  background: transparent;
  border: 0;
  font-size: 1.5rem;
  font-weight: 700;
  line-height: 1;
  color: #000;
  text-shadow: 0 1px 0 #fff;
  opacity: 0.5;
  cursor: pointer;
}
.modal .close:hover {
  opacity: 0.75;
}
.modal .close:focus {
  outline: none;
  opacity: 0.75;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <!-- Event Details -->
        <div class="col-md-8">
            <div class="card event-card">
                <div class="card-header">
                    <h3 class="card-title">
                        <i class="fas fa-calendar-alt"></i> {{ event.title }}
                    </h3>
                    <div class="card-tools">
                        {% if event.status == 'pending' %}
                            <span class="badge badge-warning badge-lg">
                                <i class="fas fa-clock"></i> Kutilmoqda
                            </span>
                        {% elif event.status == 'approved' %}
                            <span class="badge badge-success badge-lg">
                                <i class="fas fa-check"></i> Tasdiqlangan
                            </span>
                        {% elif event.status == 'rejected' %}
                            <span class="badge badge-danger badge-lg">
                                <i class="fas fa-times"></i> Rad etilgan
                            </span>
                        {% endif %}
                    </div>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <table class="table table-borderless">
                                <tr>
                                    <td><strong><i class="fas fa-tag"></i> Kategoriya:</strong></td>
                                    <td><span class="badge bg-success text-dark me-2">{{ event.get_category_display }}</span></td>
                                </tr>
                                <tr>
                                    <td><strong><i class="fas fa-calendar"></i> Sana:</strong></td>
                                    <td>{{ event.event_date|date:"d.m.Y H:i" }}</td>
                                </tr>
                                <tr>
                                    <td><strong><i class="fas fa-map-marker-alt"></i> Joy:</strong></td>
                                    <td>{{ event.location }}</td>
                                </tr>
                                <tr>
                                    <td><strong><i class="fas fa-users"></i> Ishtirokchilar:</strong></td>
                                    <td><span class="badge badge-secondary">{{ event.participants_count }} kishi</span></td>
                                </tr>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <table class="table table-borderless">
                                <tr>
                                    <td><strong><i class="fas fa-user"></i> Tashkilotchi:</strong></td>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <div class="avatar-circle mr-2">
                                                {{ event.organizer.first_name.0 }}{{ event.organizer.last_name.0 }}
                                            </div>
                                            {{ event.organizer.get_full_name }}
                                        </div>
                                    </td>
                                </tr>
                                <tr>
                                    <td><strong><i class="fas fa-calendar-plus"></i> Yaratilgan:</strong></td>
                                    <td>{{ event.created_at|date:"d.m.Y H:i" }}</td>
                                </tr>
                                {% if event.reviewed_by %}
                                <tr>
                                    <td><strong><i class="fas fa-user-check"></i> Ko'rib chiqdi:</strong></td>
                                    <td>{{ event.reviewed_by.get_full_name }}</td>
                                </tr>
                                <tr>
                                    <td><strong><i class="fas fa-clock"></i> Ko'rib chiqilgan:</strong></td>
                                    <td>{{ event.reviewed_at|date:"d.m.Y H:i" }}</td>
                                </tr>
                                {% endif %}
                            </table>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-12">
                            <h5><i class="fas fa-align-left"></i> Tadbir haqida:</h5>
                            <div class="event-description">
                                <p>{{ event.description|linebreaks }}</p>
                            </div>
                        </div>
                    </div>
                    {% if event.dean_comment %}
                    <div class="row mt-3">
                        <div class="col-12">
                            <h5><i class="fas fa-comment"></i> Dekan izohi:</h5>
                            <div class="dean-comment">
                                <p>{{ event.dean_comment|linebreaks }}</p>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
                <div class="card-footer">
                    {% if user.is_tutor %}
                        <a href="{% url 'event_list' %}" class="btn btn-secondary">
                            <i class="fas fa-arrow-left"></i> Orqaga
                        </a>
                    {% elif user.is_dean %}
                        <a href="{% url 'dean_events' %}" class="btn btn-secondary">
                            <i class="fas fa-arrow-left"></i> Orqaga
                        </a>
                    {% endif %}
                </div>
            </div>
        </div>
        <!-- Event Photos -->
        <div class="col-md-4">
            <div class="card event-card">
                <div class="card-header">
                    <h3 class="card-title">
                        <i class="fas fa-images"></i> Tadbir rasmlari
                        <span class="badge badge-primary">{{ photos.count }}</span>
                    </h3>
                </div>
                <div class="card-body p-0">
                    {% if photos %}
                    <div class="photos-grid">
                        {% for photo in photos %}
                        <div class="photo-item">
                            <img src="{{ photo.photo.url }}" alt="Tadbir rasmi" 
                                 class="photo-thumbnail" 
                                 onclick="showImageModal('{{ photo.photo.url }}', '{{ photo.caption|escapejs }}')">
                            {% if photo.caption %}
                            <div class="photo-caption">
                                <small>{{ photo.caption|truncatechars:50 }}</small>
                            </div>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="text-center p-4">
                        <i class="fas fa-image fa-3x text-muted mb-3"></i>
                        <p class="text-muted">Bu tadbirda rasmlar yo'q</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Image Modal -->
<div class="modal fade" id="imageModal" tabindex="-1" aria-labelledby="imageModalTitle" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="imageModalTitle">Rasm</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body text-center">
                <img id="modalImage" src="/placeholder.svg" class="img-fluid" alt="Tadbir rasmi">
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function showImageModal(imageUrl, caption) {
    console.log('showImageModal called:', imageUrl, caption); // Debug log
    try {
        document.getElementById('modalImage').src = imageUrl;
        document.getElementById('imageModalTitle').textContent = caption || 'Tadbir rasmi';
        $('#imageModal').modal('show');
    } catch (error) {
        console.error('Error in showImageModal:', error);
    }
}

// Dean Events JavaScript
let currentEventId = null;
let currentAction = null;

function viewEvent(eventId) {
    fetch(`/events/${eventId}/details/`)
        .then((response) => response.json())
        .then((data) => {
            document.getElementById("eventDetails").innerHTML = data.html;
            window.jQuery("#eventModal").modal("show");
        })
        .catch((error) => {
            console.error("Error:", error);
            showNotification("Xatolik yuz berdi!", "danger");
        });
}

function approveEvent(eventId) {
    currentEventId = eventId;
    currentAction = "approve";
    document.getElementById("approvalModalTitle").textContent = "Tadbirni tasdiqlash";
    document.getElementById("approvalSubmitBtn").textContent = "Tasdiqlash";
    document.getElementById("approvalSubmitBtn").className = "btn btn-success";
    window.jQuery("#approvalModal").modal("show");
}

function rejectEvent(eventId) {
    currentEventId = eventId;
    currentAction = "reject";
    document.getElementById("approvalModalTitle").textContent = "Tadbirni rad etish";
    document.getElementById("approvalSubmitBtn").textContent = "Rad etish";
    document.getElementById("approvalSubmitBtn").className = "btn btn-danger";
    window.jQuery("#approvalModal").modal("show");
}

document.getElementById("approvalForm").addEventListener("submit", (e) => {
    e.preventDefault();
    const deanComment = document.getElementById("dean_comment").value.trim();
    const submitBtn = document.getElementById("approvalSubmitBtn");
    submitBtn.classList.add("btn-loading");
    submitBtn.disabled = true;
    const formData = new FormData();
    formData.append("action", currentAction);
    formData.append("dean_comment", deanComment);
    formData.append("csrfmiddlewaretoken", document.querySelector("[name=csrfmiddlewaretoken]").value);
    fetch(`/events/${currentEventId}/approve/`, {
        method: "POST",
        body: formData,
    })
        .then((response) => response.json())
        .then((data) => {
            if (data.success) {
                window.jQuery("#approvalModal").modal("hide");
                showNotification(
                    currentAction === "approve" ? "Tadbir tasdiqlandi!" : "Tadbir rad etildi!",
                    currentAction === "approve" ? "success" : "warning"
                );
                setTimeout(() => {
                    window.location.reload();
                }, 1500);
            } else {
                showNotification("Xatolik yuz berdi!", "danger");
            }
        })
        .catch((error) => {
            console.error("Error:", error);
            showNotification("Xatolik yuz berdi!", "danger");
        })
        .finally(() => {
            submitBtn.classList.remove("btn-loading");
            submitBtn.disabled = false;
        });
});

window.jQuery("#approvalModal").on("hidden.bs.modal", () => {
    document.getElementById("dean_comment").value = "";
    currentEventId = null;
    currentAction = null;
});

function showNotification(message, type = "info") {
    const notification = document.createElement("div");
    notification.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    notification.style.cssText = "top: 20px; right: 20px; z-index: 9999; min-width: 300px;";
    notification.innerHTML = `
        ${message}
        <button type="button" class="close" data-dismiss="alert">
            <span>&times;</span>
        </button>
    `;
    document.body.appendChild(notification);
    setTimeout(() => {
        if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
        }
    }, 5000);
}

setInterval(() => {
    const currentUrl = new URL(window.location);
    if (currentUrl.searchParams.get("status") === "pending" || !currentUrl.searchParams.get("status")) {
        window.location.reload();
    }
}, 300000);

const csrfToken = document.querySelector("[name=csrfmiddlewaretoken]")?.value;
if (csrfToken) {
    const originalFetch = window.fetch;
    window.fetch = (url, options = {}) => {
        if (options.method && options.method.toUpperCase() !== "GET") {
            options.headers = options.headers || {};
            options.headers["X-CSRFToken"] = csrfToken;
        }
        return originalFetch(url, options);
    };
}

const $ = window.jQuery;
</script>
{% endblock %}